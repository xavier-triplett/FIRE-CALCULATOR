<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coast FIRE & Three-Bucket Retirement Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .input-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.25rem;
            display: block;
        }
        .input-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Tooltip container */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            font-weight: normal;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-green-400"></i> Coast FIRE Dashboard
            </h1>
            <div class="flex items-center gap-4">
                <button onclick="resetData()" class="text-xs text-gray-400 hover:text-white underline">Reset Data</button>
                <p class="text-sm text-gray-400 mt-2 md:mt-0">Track Tax-Deferred, Tax-Free, and After-Tax Buckets</p>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-4">
        
        <!-- LEFT SIDEBAR: CONTROLS -->
        <aside class="lg:col-span-3 space-y-6 overflow-y-auto h-auto lg:h-[calc(100vh-100px)] pr-2">
            
            <!-- Personal Data -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-slate-800 mb-3 border-b pb-2">Profile</h3>
                <div class="space-y-3">
                    <div class="input-group">
                        <label>Current Age</label>
                        <input type="number" id="currentAge" value="30">
                    </div>
                    <div class="input-group">
                        <label>Early Retirement Age</label>
                        <input type="number" id="retireAge" value="50">
                    </div>
                    <div class="input-group">
                        <label>Standard Access Age</label>
                        <input type="number" id="standardRetireAge" value="60" title="Age you can access 401k/IRA penalty free">
                    </div>
                </div>
            </div>

            <!-- Income & Savings -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-slate-800 mb-3 border-b pb-2">Income & Savings</h3>
                <div class="space-y-3">
                    <div class="input-group">
                        <label>Annual Gross Income ($)</label>
                        <input type="number" id="income" value="120000" step="1000">
                    </div>
                    
                    <!-- Savings Rate Section -->
                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-100 space-y-3">
                        <div class="input-group">
                            <label class="text-blue-800">Starting Savings Rate (%)</label>
                            <input type="number" id="savingsRate" value="25" step="1">
                        </div>
                        <div class="flex gap-2">
                            <div class="input-group w-1/2">
                                <label class="text-xs text-blue-600">Annual Increase (%)</label>
                                <input type="number" id="savingsRateIncrease" value="1" step="0.5">
                            </div>
                            <div class="input-group w-1/2">
                                <label class="text-xs text-blue-600">Max Cap (%)</label>
                                <input type="number" id="maxSavingsRate" value="50" step="1">
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Current Annual Expenses ($)</label>
                        <input type="number" id="expenses" value="60000" step="1000">
                    </div>
                    <div class="input-group">
                        <label>Income Growth Rate (%)</label>
                        <input type="number" id="incomeGrowth" value="3" step="0.1">
                    </div>
                </div>
            </div>

            <!-- Current Buckets -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-slate-800 mb-3 border-b pb-2">Current Buckets</h3>
                <div class="space-y-3">
                    <div class="input-group border-l-4 border-orange-400 pl-2">
                        <label>Tax Deferred (401k/IRA)</label>
                        <input type="number" id="balDeferred" value="150000" step="1000">
                    </div>
                    <div class="input-group border-l-4 border-emerald-400 pl-2">
                        <label>Tax Free (Roth)</label>
                        <input type="number" id="balFree" value="40000" step="1000">
                    </div>
                    <div class="input-group border-l-4 border-blue-500 pl-2">
                        <label>After Tax (Brokerage)</label>
                        <input type="number" id="balTaxable" value="25000" step="1000">
                    </div>
                </div>
            </div>

            <!-- CONTRIBUTION PHASES (Dynamic) -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3 border-b pb-2">
                    <h3 class="text-lg font-bold text-slate-800">Saving Phases</h3>
                    <button onclick="addPhase()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition">
                        <i class="fa-solid fa-plus"></i> Add
                    </button>
                </div>
                <p class="text-xs text-gray-500 mb-2">Define how your savings are split at different ages.</p>
                
                <div id="phasesContainer" class="space-y-4">
                    <!-- Phases injected by JS -->
                </div>
            </div>

            <!-- DRAWDOWN STRATEGY -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-slate-800 mb-3 border-b pb-2">Drawdown Strategy</h3>
                <p class="text-xs text-gray-500 mb-2">Define source priority for each phase.</p>
                
                <!-- Bridge Phase Controls -->
                <div class="mb-4 p-2 bg-blue-50 rounded border border-blue-100">
                    <h4 class="text-xs font-bold text-blue-800 mb-2 uppercase">Phase 1: Bridge (Pre-<span id="dispStandardAgeSmall">60</span>)</h4>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-blue-600">Brokerage %</label>
                            <input type="number" id="drawTaxableBridge" value="100" class="draw-input text-right w-16 text-xs p-1 border rounded">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-orange-600">Deferred %</label>
                            <input type="number" id="drawDeferredBridge" value="0" class="draw-input text-right w-16 text-xs p-1 border rounded">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-emerald-600">Roth %</label>
                            <input type="number" id="drawFreeBridge" value="0" class="draw-input text-right w-16 text-xs p-1 border rounded">
                        </div>
                        <div class="flex justify-between text-[10px] font-bold pt-1 border-t border-blue-200">
                            <span>Total:</span>
                            <span id="drawTotalBridge" class="text-green-600">100%</span>
                        </div>
                    </div>
                </div>

                <!-- Standard Phase Controls -->
                <div class="p-2 bg-green-50 rounded border border-green-100">
                    <h4 class="text-xs font-bold text-green-800 mb-2 uppercase">Phase 2: Standard (60+)</h4>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-blue-600">Brokerage %</label>
                            <input type="number" id="drawTaxableStd" value="20" class="draw-input text-right w-16 text-xs p-1 border rounded">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-orange-600">Deferred %</label>
                            <input type="number" id="drawDeferredStd" value="40" class="draw-input text-right w-16 text-xs p-1 border rounded">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-emerald-600">Roth %</label>
                            <input type="number" id="drawFreeStd" value="40" class="draw-input text-right w-16 text-xs p-1 border rounded">
                        </div>
                        <div class="flex justify-between text-[10px] font-bold pt-1 border-t border-green-200">
                            <span>Total:</span>
                            <span id="drawTotalStd" class="text-green-600">100%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Assumptions -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-slate-800 mb-3 border-b pb-2">Assumptions</h3>
                <div class="space-y-3">
                    <div class="input-group">
                        <label>Market Return (%)</label>
                        <input type="number" id="marketReturn" value="7" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Inflation Rate (%)</label>
                        <input type="number" id="inflation" value="3" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Safe Withdrawal Rate (%)</label>
                        <input type="number" id="swr" value="4.0" step="0.1">
                    </div>
                </div>
            </div>
        </aside>

        <!-- RIGHT DASHBOARD -->
        <main class="lg:col-span-9 space-y-6">
            
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Bridge Fund Metric -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500 font-semibold uppercase">Goal 1: The Bridge</p>
                            <p class="text-[10px] text-gray-400 mb-1">Covering Age <span id="dispRetireAge">50</span> to <span id="dispStandardAge">60</span></p>
                            <h2 class="text-xl font-bold text-gray-800" id="bridgeStatus">Calculating...</h2>
                        </div>
                        <i class="fa-solid fa-bridge-water text-blue-200 text-3xl"></i>
                    </div>
                    <p class="text-xs text-gray-500 mt-2" id="bridgeMessage">...</p>
                </div>

                <!-- Coast Metric -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-purple-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500 font-semibold uppercase">Goal 2: Traditional Coast</p>
                            <p class="text-[10px] text-gray-400 mb-1">Covering Age <span id="dispStandardAge2">60</span>+</p>
                            <h2 class="text-xl font-bold text-gray-800" id="coastStatus">Analyzing...</h2>
                        </div>
                        <i class="fa-solid fa-umbrella-beach text-purple-200 text-3xl"></i>
                    </div>
                    <p class="text-xs text-gray-500 mt-2" id="coastMessage">...</p>
                </div>

                <!-- FI Number Card with Tooltip -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-red-400 relative group">
                    <div class="absolute top-2 right-2 text-gray-300 hover:text-gray-500 tooltip">
                        <i class="fa-solid fa-circle-question"></i>
                        <span class="tooltiptext">
                            <strong>FI Number</strong> = Annual Expenses / SWR.<br/><br/>
                            This assumes you live off portfolio growth forever (Perpetual Withdrawal). <br/><br/>
                            You may be successful (Status: FUNDED) even if you never hit this number, provided you are spending down your principal (Spend-Down Model).
                        </span>
                    </div>
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500 font-semibold uppercase">FI Requirement</p>
                            <p class="text-[10px] text-gray-400 mb-1">Perpetual Growth Number</p>
                            <h2 class="text-2xl font-bold text-gray-800" id="fiNumberVal">$0</h2>
                        </div>
                        <i class="fa-solid fa-fire text-red-200 text-3xl"></i>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Total NW at Retire: <span id="netWorthAtRetire" class="font-bold text-gray-600">$0</span></p>
                </div>
            </div>

            <!-- Chart Area -->
            <div class="bg-white p-4 rounded-xl shadow-md h-[400px] relative">
                <canvas id="wealthChart"></canvas>
            </div>

            <!-- Explainer Text -->
            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-xl text-sm text-yellow-800">
                <p class="font-bold mb-1"><i class="fa-solid fa-lightbulb text-yellow-600"></i> Why am I "Funded" if I'm below the Red Line?</p>
                <p class="opacity-90">
                    The Red Dashed Line represents the amount needed to live off investment <strong>growth alone</strong> (never touching principal). 
                    In a "Bridge" or "Coast" strategy, you often spend your principal down to zero (e.g., emptying your brokerage account to get to age 60). 
                    Being below the line is fine as long as your buckets don't hit $0 before you die.
                </p>
            </div>

            <!-- Detailed Table -->
            <div class="bg-white p-4 rounded-xl shadow-md overflow-hidden">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Year-by-Year Projection</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-xs text-gray-500 border-b-2 border-gray-200 bg-gray-50">
                                <th class="p-3">Age</th>
                                <th class="p-3">Year</th>
                                <th class="p-3 text-orange-600">Tax Deferred</th>
                                <th class="p-3 text-emerald-600">Tax Free</th>
                                <th class="p-3 text-blue-600">After Tax</th>
                                <th class="p-3 font-bold">Total NW</th>
                                <th class="p-3">Sav Rate</th>
                                <th class="p-3">Contribution</th>
                                <th class="p-3">Withdrawal</th>
                                <th class="p-3">Status</th>
                            </tr>
                        </thead>
                        <tbody id="projectionBody" class="text-sm text-gray-700">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast">Settings Saved</div>

    <script>
        // --- STATE ---
        // Default phases. User can edit these.
        let phases = [
            { id: 1, age: 30, deferred: 50, free: 50, taxable: 0, isLocked: true }
        ];
        
        // --- PERSISTENCE LOGIC (NEW) ---
        const STORAGE_KEY = 'coastFireData_v1';
        let isLoaded = false;

        function saveSettings() {
            if (!isLoaded) return; // Don't save before initial load

            const inputs = {};
            document.querySelectorAll('input').forEach(inp => {
                if (inp.id) inputs[inp.id] = inp.value;
            });

            const data = {
                inputs: inputs,
                phases: phases
            };

            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            // Optional: showToast(); 
        }

        function loadSettings() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // Restore Inputs
                    if (data.inputs) {
                        for (const [id, val] of Object.entries(data.inputs)) {
                            const el = document.getElementById(id);
                            if (el) el.value = val;
                        }
                    }
                    
                    // Restore Phases
                    if (data.phases) {
                        phases = data.phases;
                    }

                    showToast("Settings Loaded from Browser Storage");
                } catch (e) {
                    console.error("Error loading settings", e);
                }
            }
            isLoaded = true;
            renderPhases();
            validateDrawdown();
        }

        function resetData() {
            if(confirm("Reset all data to defaults?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function showToast(msg = "Settings Saved") {
            const x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- UTILITIES ---
        const formatCurrency = (num) => {
            if(num < 0) return '-' + formatCurrency(Math.abs(num));
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(num);
        };

        // --- UI MANAGEMENT (PHASES) ---
        function renderPhases() {
            const container = document.getElementById('phasesContainer');
            container.innerHTML = '';

            // Ensure they are sorted by age
            phases.sort((a, b) => a.age - b.age);

            phases.forEach((phase, index) => {
                const div = document.createElement('div');
                div.className = "p-3 bg-gray-50 rounded border border-gray-200 relative group";
                
                // Delete button (if not first)
                let deleteBtn = '';
                if (!phase.isLocked) {
                    deleteBtn = `<button onclick="removePhase(${phase.id})" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>`;
                }

                // Age Input
                let ageInput = phase.isLocked 
                    ? `<input type="number" id="phaseAge_${phase.id}" value="${document.getElementById('currentAge').value}" disabled class="bg-gray-100 text-gray-500 cursor-not-allowed">`
                    : `<input type="number" value="${phase.age}" onchange="updatePhase(${phase.id}, 'age', this.value)">`;

                let ageLabel = phase.isLocked ? "Starting Age (Current)" : "Starting Age";

                div.innerHTML = `
                    ${deleteBtn}
                    <div class="mb-2">
                        <label class="text-xs font-bold text-gray-700">${ageLabel}</label>
                        ${ageInput}
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-[10px] text-orange-600">Def %</label>
                            <input type="number" value="${phase.deferred}" onchange="updatePhase(${phase.id}, 'deferred', this.value)" class="text-xs p-1 border rounded w-full">
                        </div>
                        <div>
                            <label class="text-[10px] text-emerald-600">Free %</label>
                            <input type="number" value="${phase.free}" onchange="updatePhase(${phase.id}, 'free', this.value)" class="text-xs p-1 border rounded w-full">
                        </div>
                        <div>
                            <label class="text-[10px] text-blue-600">Taxable %</label>
                            <input type="number" value="${phase.taxable}" readonly class="text-xs p-1 border rounded w-full bg-gray-100 text-gray-500">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addPhase() {
            const maxId = phases.reduce((max, p) => p.id > max ? p.id : max, 0);
            const prevPhase = phases[phases.length - 1];
            phases.push({
                id: maxId + 1,
                age: prevPhase.age + 5,
                deferred: 0,
                free: 0,
                taxable: 100,
                isLocked: false
            });
            renderPhases();
            calculateAndRender();
        }

        function removePhase(id) {
            phases = phases.filter(p => p.id !== id);
            renderPhases();
            calculateAndRender();
        }

        function updatePhase(id, field, value) {
            const phase = phases.find(p => p.id === id);
            if (phase) {
                phase[field] = parseInt(value) || 0;
                
                // Recalculate taxable remainder
                if(field === 'deferred' || field === 'free') {
                    let rem = 100 - phase.deferred - phase.free;
                    phase.taxable = rem < 0 ? 0 : rem;
                }
            }
            renderPhases(); 
            calculateAndRender();
        }

        // --- DRAWDOWN UI VALIDATION ---
        document.querySelectorAll('.draw-input').forEach(input => {
            input.addEventListener('change', validateDrawdown);
        });

        function validateDrawdown() {
            // Bridge Validation
            let tb = parseInt(document.getElementById('drawTaxableBridge').value) || 0;
            let db = parseInt(document.getElementById('drawDeferredBridge').value) || 0;
            let fb = parseInt(document.getElementById('drawFreeBridge').value) || 0;
            let totalB = tb + db + fb;
            const totalElB = document.getElementById('drawTotalBridge');
            totalElB.innerText = totalB + "%";
            totalElB.className = totalB !== 100 ? "text-red-600 font-bold animate-pulse" : "text-green-600";

            // Standard Validation
            let ts = parseInt(document.getElementById('drawTaxableStd').value) || 0;
            let ds = parseInt(document.getElementById('drawDeferredStd').value) || 0;
            let fs = parseInt(document.getElementById('drawFreeStd').value) || 0;
            let totalS = ts + ds + fs;
            const totalElS = document.getElementById('drawTotalStd');
            totalElS.innerText = totalS + "%";
            totalElS.className = totalS !== 100 ? "text-red-600 font-bold animate-pulse" : "text-green-600";

            calculateAndRender();
        }


        // --- MAIN LOGIC ---
        let chartInstance = null;

        function getInputs() {
            return {
                currentAge: parseInt(document.getElementById('currentAge').value),
                retireAge: parseInt(document.getElementById('retireAge').value),
                standardRetireAge: parseInt(document.getElementById('standardRetireAge').value),
                income: parseFloat(document.getElementById('income').value),
                
                savingsRate: parseFloat(document.getElementById('savingsRate').value) / 100,
                savingsRateIncrease: parseFloat(document.getElementById('savingsRateIncrease').value) / 100,
                maxSavingsRate: parseFloat(document.getElementById('maxSavingsRate').value) / 100,

                expenses: parseFloat(document.getElementById('expenses').value),
                incomeGrowth: parseFloat(document.getElementById('incomeGrowth').value) / 100,
                
                balDeferred: parseFloat(document.getElementById('balDeferred').value),
                balFree: parseFloat(document.getElementById('balFree').value),
                balTaxable: parseFloat(document.getElementById('balTaxable').value),
                
                marketReturn: parseFloat(document.getElementById('marketReturn').value) / 100,
                inflation: parseFloat(document.getElementById('inflation').value) / 100,
                swr: parseFloat(document.getElementById('swr').value) / 100,

                // Drawdown Prefs Bridge
                drawTaxableBridge: (parseInt(document.getElementById('drawTaxableBridge').value) || 0) / 100,
                drawDeferredBridge: (parseInt(document.getElementById('drawDeferredBridge').value) || 0) / 100,
                drawFreeBridge: (parseInt(document.getElementById('drawFreeBridge').value) || 0) / 100,

                // Drawdown Prefs Standard
                drawTaxableStd: (parseInt(document.getElementById('drawTaxableStd').value) || 0) / 100,
                drawDeferredStd: (parseInt(document.getElementById('drawDeferredStd').value) || 0) / 100,
                drawFreeStd: (parseInt(document.getElementById('drawFreeStd').value) || 0) / 100,
            };
        }

        function calculateAndRender() {
            const data = getInputs();
            
            // AUTO SAVE TRIGGER
            saveSettings();

            const currentYear = new Date().getFullYear();
            const projection = [];
            
            let curDeferred = data.balDeferred;
            let curFree = data.balFree;
            let curTaxable = data.balTaxable;
            let curIncome = data.income;
            let curExpenses = data.expenses;
            let curSavingsRate = data.savingsRate; 

            // Trackers
            let bridgeFailureAge = null; 
            let standardSuccess = false;
            let standardCoverage = 0;
            let ranOutOfMoneyAge = null;

            const maxAge = 95;
            let netWorthAtRetirement = 0;
            let expensesAtRetirement = 0;

            for (let age = data.currentAge; age <= maxAge; age++) {
                const isRetired = age >= data.retireAge;
                const isStandardAge = age >= data.standardRetireAge;
                const yearIndex = age - data.currentAge;
                const yearLabel = currentYear + yearIndex;
                const growthRate = data.marketReturn; 

                // 1. Growth
                curDeferred *= (1 + growthRate);
                curFree *= (1 + growthRate);
                curTaxable *= (1 + growthRate);

                let withdrawalSource = ""; // For table display
                let contributionSource = "";

                // 2. Flows
                if (!isRetired) {
                    // --- WORKING PHASE ---
                    let activePhase = phases.concat().sort((a,b) => b.age - a.age).find(p => p.age <= age);
                    if(!activePhase) activePhase = phases[0]; // Fallback

                    let totalSavings = curIncome * curSavingsRate;
                    
                    let cD = totalSavings * (activePhase.deferred / 100);
                    let cF = totalSavings * (activePhase.free / 100);
                    let cT = totalSavings * (activePhase.taxable / 100);

                    curDeferred += cD;
                    curFree += cF;
                    curTaxable += cT;

                    // Contribution String
                    let cParts = [];
                    if(cT > 0) cParts.push(`T:$${Math.round(cT/1000)}k`);
                    if(cD > 0) cParts.push(`D:$${Math.round(cD/1000)}k`);
                    if(cF > 0) cParts.push(`F:$${Math.round(cF/1000)}k`);
                    contributionSource = cParts.join(' ');
                    
                    // Ramp up Savings Rate
                    if (curSavingsRate < data.maxSavingsRate) {
                        curSavingsRate += data.savingsRateIncrease;
                        if (curSavingsRate > data.maxSavingsRate) curSavingsRate = data.maxSavingsRate;
                    }

                    // Inflate
                    curIncome *= (1 + data.incomeGrowth);
                    curExpenses *= (1 + data.inflation);

                } else {
                    // --- RETIREMENT PHASE ---
                    let need = curExpenses;
                    let totalWealth = curDeferred + curFree + curTaxable;

                    if (totalWealth <= 0) {
                        if(!ranOutOfMoneyAge) ranOutOfMoneyAge = age;
                        // Broke
                    } else {
                        // DRAWDOWN LOGIC
                        let wantTaxable = 0;
                        let wantDeferred = 0;
                        let wantFree = 0;

                        if(!isStandardAge) {
                             // Use Bridge Prefs
                             wantTaxable = need * data.drawTaxableBridge;
                             wantDeferred = need * data.drawDeferredBridge;
                             wantFree = need * data.drawFreeBridge;
                        } else {
                             // Use Standard Prefs
                             wantTaxable = need * data.drawTaxableStd;
                             wantDeferred = need * data.drawDeferredStd;
                             wantFree = need * data.drawFreeStd;
                        }

                        // 2. Function to take money safely
                        const take = (amount, available) => Math.min(amount, available);

                        let takenTaxable = take(wantTaxable, curTaxable);
                        let takenDeferred = take(wantDeferred, curDeferred);
                        let takenFree = take(wantFree, curFree);

                        curTaxable -= takenTaxable;
                        curDeferred -= takenDeferred;
                        curFree -= takenFree;

                        let totalTaken = takenTaxable + takenDeferred + takenFree;
                        let shortfall = need - totalTaken;

                        // 3. Handle Shortfall (Equal Split Logic among survivors)
                        if (shortfall > 0.01) { 
                            let sources = [];
                            if (curTaxable > 0) sources.push('taxable');
                            if (curDeferred > 0) sources.push('deferred');
                            if (curFree > 0) sources.push('free');

                            if (sources.length > 0) {
                                let stillNeed = shortfall;
                                let loopGuard = 0;
                                while (stillNeed > 1 && loopGuard < 10) {
                                    let activeSources = [];
                                    if (curTaxable > 0) activeSources.push('taxable');
                                    if (curDeferred > 0) activeSources.push('deferred');
                                    if (curFree > 0) activeSources.push('free');
                                    
                                    if(activeSources.length === 0) break;

                                    let chunk = stillNeed / activeSources.length;
                                    
                                    activeSources.forEach(src => {
                                        if(src === 'taxable') {
                                            let t = Math.min(chunk, curTaxable);
                                            curTaxable -= t;
                                            stillNeed -= t;
                                            takenTaxable += t;
                                        } else if (src === 'deferred') {
                                            let t = Math.min(chunk, curDeferred);
                                            curDeferred -= t;
                                            stillNeed -= t;
                                            takenDeferred += t;
                                        } else {
                                            let t = Math.min(chunk, curFree);
                                            curFree -= t;
                                            stillNeed -= t;
                                            takenFree += t;
                                        }
                                    });
                                    loopGuard++;
                                }
                            }
                        }
                        
                        // Bridge Failure Check
                        if (!isStandardAge) {
                            if (curTaxable <= 0 && shortfall > 0) {
                                if(bridgeFailureAge === null) bridgeFailureAge = age;
                            }
                        }
                        
                        // Build display string for table
                        let pT = Math.round((takenTaxable/need)*100);
                        let pD = Math.round((takenDeferred/need)*100);
                        let pF = Math.round((takenFree/need)*100);
                        withdrawalSource = `T:${pT}% D:${pD}% F:${pF}%`;
                    }

                    // Inflate Expenses
                    curExpenses *= (1 + data.inflation);
                }

                // Clean up
                if (curDeferred < 0) curDeferred = 0;
                if (curFree < 0) curFree = 0;
                if (curTaxable < 0) curTaxable = 0;

                let totalNW = curDeferred + curFree + curTaxable;

                // Snapshots
                if (age === data.retireAge) {
                    netWorthAtRetirement = totalNW;
                    expensesAtRetirement = curExpenses / (1 + data.inflation); 
                }

                // Check Traditional Readiness
                if (age === data.standardRetireAge) {
                    let taxAdvantagedTotal = curDeferred + curFree;
                    let safeWithdrawalAmount = taxAdvantagedTotal * data.swr;
                    let expenseNeed = curExpenses / (1+data.inflation);
                    standardCoverage = (safeWithdrawalAmount / expenseNeed) * 100;
                    if (safeWithdrawalAmount >= expenseNeed) {
                        standardSuccess = true;
                    }
                }

                projection.push({
                    age,
                    year: yearLabel,
                    deferred: curDeferred,
                    free: curFree,
                    taxable: curTaxable,
                    total: totalNW,
                    expenses: curExpenses,
                    isRetired,
                    effectiveSavingsRate: isRetired ? 0 : curSavingsRate,
                    withdrawalSource,
                    contributionSource
                });
            }

            // --- UPDATE UI ---
            document.getElementById('dispRetireAge').innerText = data.retireAge;
            document.getElementById('dispStandardAge').innerText = data.standardRetireAge;
            document.getElementById('dispStandardAge2').innerText = data.standardRetireAge;
            document.getElementById('dispStandardAgeSmall').innerText = data.standardRetireAge;
            
            // Bridge Status
            const bridgeStatusEl = document.getElementById('bridgeStatus');
            const bridgeMsgEl = document.getElementById('bridgeMessage');
            
            if (data.retireAge >= data.standardRetireAge) {
                bridgeStatusEl.innerText = "N/A";
                bridgeStatusEl.className = "text-xl font-bold text-gray-400";
                bridgeMsgEl.innerText = "Retiring after standard age.";
            } else if (bridgeFailureAge) {
                bridgeStatusEl.innerText = "Empty at " + bridgeFailureAge;
                bridgeStatusEl.className = "text-xl font-bold text-red-500";
                bridgeMsgEl.innerText = "Had to tap retirement buckets early.";
            } else {
                bridgeStatusEl.innerText = "SECURE";
                bridgeStatusEl.className = "text-xl font-bold text-blue-600";
                bridgeMsgEl.innerText = "Bridge funds lasted until " + data.standardRetireAge;
            }

            // Coast Status
            const coastStatusEl = document.getElementById('coastStatus');
            const coastMsgEl = document.getElementById('coastMessage');
            
            if (ranOutOfMoneyAge) {
                 coastStatusEl.innerText = "BROKE AT " + ranOutOfMoneyAge;
                 coastStatusEl.className = "text-xl font-bold text-red-600 animate-pulse";
                 coastMsgEl.innerText = "Portfolio depleted before age 95.";
            } else if (standardSuccess) {
                coastStatusEl.innerText = "SECURE";
                coastStatusEl.className = "text-xl font-bold text-purple-600";
                coastMsgEl.innerText = `Tax-Advantaged accounts cover ${standardCoverage.toFixed(0)}% of needs at ${data.standardRetireAge}.`;
            } else {
                coastStatusEl.innerText = `${standardCoverage.toFixed(0)}% FUNDED`;
                coastStatusEl.className = "text-xl font-bold text-orange-500";
                coastMsgEl.innerText = `Tax-Advantaged might fall short. Total portfolio is carrying the load.`;
            }

            // KPI Cards
            let fiNum = expensesAtRetirement / data.swr;
            document.getElementById('fiNumberVal').innerText = formatCurrency(fiNum);
            document.getElementById('netWorthAtRetire').innerText = formatCurrency(netWorthAtRetirement);

            renderTable(projection);
            renderChart(projection, fiNum);
        }

        function renderTable(data) {
            const tbody = document.getElementById('projectionBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                
                let bgClass = "border-b border-gray-100 hover:bg-gray-50";
                let statusBadge = `<span class="px-2 py-1 rounded-full bg-gray-200 text-gray-600 text-xs">Working</span>`;
                
                const inputs = getInputs();

                if (row.isRetired) {
                    if (row.total <= 0) {
                        bgClass = "bg-red-100 border-b border-red-200";
                        statusBadge = `<span class="px-2 py-1 rounded-full bg-red-600 text-white text-xs font-bold">BROKE</span>`;
                    } else if (row.age < inputs.standardRetireAge) {
                        bgClass = "bg-blue-50 border-b border-blue-100";
                        statusBadge = `<span class="px-2 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-bold">Bridge</span>`;
                    } else {
                        bgClass = "bg-green-50 border-b border-green-100";
                        statusBadge = `<span class="px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs font-bold">Retired</span>`;
                    }
                }

                tr.className = bgClass;
                
                let col7 = !row.isRetired 
                    ? (row.effectiveSavingsRate * 100).toFixed(1) + '%' 
                    : '<span class="text-gray-300">-</span>';
                
                let col8 = row.isRetired
                    ? `<span class="text-[10px] font-mono text-gray-500">${row.withdrawalSource}</span>`
                    : '<span class="text-gray-300">-</span>';

                let colContrib = !row.isRetired
                    ? `<span class="text-[10px] font-mono text-gray-600">${row.contributionSource}</span>`
                    : '<span class="text-gray-300">-</span>';

                tr.innerHTML = `
                    <td class="p-3 font-bold text-gray-600">${row.age}</td>
                    <td class="p-3 text-gray-500 text-xs">${row.year}</td>
                    <td class="p-3 text-orange-600 font-mono">${formatCurrency(row.deferred)}</td>
                    <td class="p-3 text-emerald-600 font-mono">${formatCurrency(row.free)}</td>
                    <td class="p-3 text-blue-600 font-mono font-bold bg-white/50 border border-transparent rounded">${formatCurrency(row.taxable)}</td>
                    <td class="p-3 font-bold font-mono">${formatCurrency(row.total)}</td>
                    <td class="p-3 text-xs text-gray-500">${col7}</td>
                    <td class="p-3 text-xs">${colContrib}</td>
                    <td class="p-3 text-xs">${col8}</td>
                    <td class="p-3">${statusBadge}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderChart(data, fiNumber) {
            const ctx = document.getElementById('wealthChart').getContext('2d');
            
            const labels = data.map(d => `Age ${d.age}`);
            const defData = data.map(d => d.deferred);
            const freeData = data.map(d => d.free);
            const taxData = data.map(d => d.taxable);
            
            // Create a straight line for FI number to visualize the gap
            const fireLine = data.map(d => d.expenses / (parseFloat(document.getElementById('swr').value)/100));

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'After Tax (Bridge)',
                            data: taxData,
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            fill: true,
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: 'Tax Free (Roth)',
                            data: freeData,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            fill: true,
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: 'Tax Deferred (401k)',
                            data: defData,
                            backgroundColor: 'rgba(249, 115, 22, 0.6)',
                            borderColor: 'rgba(249, 115, 22, 1)',
                            fill: true,
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: 'FI Number (Perpetual)',
                            data: fireLine,
                            borderColor: '#ef4444', 
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                            type: 'line'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value / 1000000 + 'M';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- EVENTS ---
        document.querySelectorAll('input').forEach(input => {
            if(!input.classList.contains('draw-input')) { // draw inputs handled separately
                input.addEventListener('input', (e) => {
                    // Update locked phase 1 age if current age changes
                    if(e.target.id === 'currentAge') {
                        phases[0].age = parseInt(e.target.value);
                        renderPhases();
                    }
                    calculateAndRender();
                });
            }
        });

        // Initialize
        loadSettings(); // Try to load first
        // If load is empty, it will render default, if not it renders saved
        
        // Fallback if nothing loaded (clean slate)
        if(!localStorage.getItem(STORAGE_KEY)) {
             renderPhases();
             validateDrawdown();
        }

    </script>
</body>
</html>
